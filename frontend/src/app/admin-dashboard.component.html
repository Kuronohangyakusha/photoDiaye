<div class="admin-dashboard">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <h2>📊 Admin Panel</h2>
    </div>
    <ul class="sidebar-menu">
      <li [class.active]="isActiveSection('dashboard')" (click)="setActiveSection('dashboard')">
        <a class="sidebar-link">
          <span class="icon">📈</span>
          <span class="text">Tableau de bord</span>
        </a>
      </li>
      <li [class.active]="isActiveSection('articles')" (click)="setActiveSection('articles')">
        <a class="sidebar-link">
          <span class="icon">📦</span>
          <span class="text">Articles</span>
        </a>
      </li>
      <li [class.active]="isActiveSection('users')" (click)="setActiveSection('users')">
        <a class="sidebar-link">
          <span class="icon">👥</span>
          <span class="text">Utilisateurs</span>
        </a>
      </li>
      <li [class.active]="isActiveSection('reports')" (click)="setActiveSection('reports')">
        <a class="sidebar-link">
          <span class="icon">🚨</span>
          <span class="text">Signalements</span>
        </a>
      </li>
      <li [class.active]="isActiveSection('history')" (click)="setActiveSection('history')">
        <a class="sidebar-link">
          <span class="icon">📚</span>
          <span class="text">Historique</span>
        </a>
      </li>
      <li [class.active]="isActiveSection('settings')" (click)="setActiveSection('settings')">
        <a class="sidebar-link">
          <span class="icon">⚙️</span>
          <span class="text">Paramètres</span>
        </a>
      </li>
    </ul>
    <div class="sidebar-footer">
      <button class="btn-logout" (click)="logout()">🚪 Déconnexion</button>
      <button class="btn-home" (click)="goHome()">🏠 Accueil</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <header class="dashboard-header">
      <div class="header-content">
        <div class="header-text">
          <h1>Tableau de bord administrateur</h1>
          <p>Bienvenue dans votre panneau d'administration</p>
        </div>
        <div class="header-actions">
          <button class="btn-notifications" (click)="toggleNotifications()" [class.has-unread]="unreadCount > 0">
            🔔 Notifications
            <span *ngIf="unreadCount > 0" class="notification-badge">{{ unreadCount }}</span>
          </button>
        </div>
      </div>
    </header>

    <div class="dashboard-content">
      <!-- Statistics Cards -->
      <div class="stats-grid" *ngIf="!isLoading && statistics">
        <div class="stat-card">
          <div class="stat-icon">📦</div>
          <div class="stat-content">
            <h3>{{ statistics.totalArticles }}</h3>
            <p>Articles totaux</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">👥</div>
          <div class="stat-content">
            <h3>{{ statistics.totalUtilisateurs }}</h3>
            <p>Utilisateurs inscrits</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">👁️</div>
          <div class="stat-content">
            <h3>{{ statistics.totalVues }}</h3>
            <p>Vues totales</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">📅</div>
          <div class="stat-content">
            <h3>{{ statistics.misAJourLe | date:'dd/MM/yyyy' }}</h3>
            <p>Dernière mise à jour</p>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading" *ngIf="isLoading">
        <p>Chargement des statistiques...</p>
      </div>

      <!-- Error State -->
      <div class="error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Dashboard Section -->
      <div *ngIf="isActiveSection('dashboard')" class="admin-sections">
        <!-- Charts Section -->
        <div class="charts-section">
          <div class="charts-grid">
            <div class="chart-card">
              <h3>Répartition des Articles</h3>
              <div class="chart-container">
                <canvas id="articlesChart"></canvas>
              </div>
            </div>

            <div class="chart-card">
              <h3>Évolution des Vues</h3>
              <div class="chart-container">
                <canvas id="viewsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions and Activity Section -->
        <div class="actions-activity-section">
          <div class="section-card">
            <h3>Actions rapides</h3>
            <div class="quick-actions">
              <button class="btn-action" (click)="generateCompleteReport()">📊 Générer rapport</button>
              <button class="btn-action" (click)="cleanupOldArticles()">🧹 Nettoyer anciens articles</button>
              <button class="btn-action">📧 Envoyer notification</button>
            </div>
          </div>

          <div class="section-card">
            <h3>Activité récente</h3>
            <div class="recent-activity">
              <p>🔄 Mise à jour des statistiques effectuée</p>
              <p>👤 Nouveau vendeur inscrit</p>
              <p>📦 Article supprimé automatiquement</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Articles Section -->
      <div *ngIf="isActiveSection('articles')" class="admin-sections">
        <div class="section-card">
          <h3>Articles en attente de validation</h3>
          <div *ngIf="articlesLoading" class="loading">
            <p>Chargement des articles...</p>
          </div>
          <div *ngIf="!articlesLoading && pendingArticles.length === 0" class="no-articles">
            <p>Aucun article en attente de validation.</p>
          </div>
          <div *ngIf="!articlesLoading && pendingArticles.length > 0" class="articles-list">
            <div *ngFor="let article of pendingArticles" class="article-item">
              <div class="article-info">
                <h4>{{ article.titre }}</h4>
                <p><strong>Prix:</strong> {{ article.prix }} FCFA</p>
                <p><strong>Vendeur:</strong> {{ article.vendeur.nom || 'N/A' }} ({{ article.vendeur.telephone }})</p>
                <p><strong>Publié le:</strong> {{ article.publieLe | date:'dd/MM/yyyy HH:mm' }}</p>
                <p><strong>Statut:</strong> <span class="status-pending">{{ article.statut }}</span></p>
              </div>
              <div class="article-actions">
                <button class="btn-approve" (click)="approveArticle(article.id)">✅ Approuver</button>
                <button class="btn-reject" (click)="openRejectModal(article.id)">❌ Rejeter</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div *ngIf="isActiveSection('users')" class="admin-sections">
        <div class="section-card">
          <h3>Gestion des Utilisateurs</h3>
          <div class="users-stats">
            <p><strong>Total utilisateurs:</strong> {{ totalUsers }}</p>
          </div>

          <div *ngIf="usersLoading" class="loading">
            <p>Chargement des utilisateurs...</p>
          </div>

          <div *ngIf="!usersLoading && users.length === 0" class="no-users">
            <p>Aucun utilisateur trouvé.</p>
          </div>

          <div *ngIf="!usersLoading && users.length > 0" class="users-list">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Téléphone</th>
                  <th>Rôle</th>
                  <th>Date d'inscription</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of users">
                  <td>{{ user.nom || 'N/A' }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.telephone }}</td>
                  <td><span class="role-badge" [class]="'role-' + user.role.toLowerCase()">{{ getRoleLabel(user.role) }}</span></td>
                  <td>{{ user.creeLe | date:'dd/MM/yyyy' }}</td>
                  <td class="actions">
                    <button class="btn-delete" (click)="deleteUser(user.id)">🗑️ Supprimer</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" *ngIf="totalPages > 1">
              <button class="btn-page" (click)="changeUserPage(currentPage - 1)" [disabled]="currentPage === 1">Précédent</button>
              <span *ngFor="let page of [].constructor(totalPages); let i = index">
                <button class="btn-page" [class.active]="i + 1 === currentPage" (click)="changeUserPage(i + 1)">{{ i + 1 }}</button>
              </span>
              <button class="btn-page" (click)="changeUserPage(currentPage + 1)" [disabled]="currentPage === totalPages">Suivant</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div *ngIf="isActiveSection('reports')" class="admin-sections">
        <div class="section-card">
          <h3>Signalements</h3>
          <p>Fonctionnalité à implémenter : Gestion des signalements d'articles, modération du contenu.</p>
        </div>
      </div>

      <!-- History Section -->
      <div *ngIf="isActiveSection('history')" class="admin-sections">
        <div class="section-card">
          <h3>Historique des Articles</h3>

          <!-- Search Controls -->
          <div class="history-controls">
            <div class="search-container">
              <input
                type="text"
                class="search-input"
                placeholder="Rechercher par titre, vendeur..."
                [(ngModel)]="historySearchQuery"
                (keyup.enter)="searchHistoryArticles()"
              >
              <button class="search-btn" (click)="searchHistoryArticles()">🔍</button>
              <button class="clear-btn" (click)="clearHistorySearch()" *ngIf="historySearchQuery">❌</button>
            </div>
          </div>

          <div class="history-stats">
            <p><strong>Total articles:</strong> {{ historyTotal }}</p>
            <p *ngIf="historySearchQuery"><em>Résultats pour: "{{ historySearchQuery }}"</em></p>
          </div>

          <div *ngIf="historyLoading" class="loading">
            <p>Chargement de l'historique...</p>
          </div>
          <div *ngIf="!historyLoading && historyArticles.length === 0" class="no-history">
            <p>Aucun article dans l'historique.</p>
          </div>
          <div *ngIf="!historyLoading && historyArticles.length > 0" class="history-list">
            <div *ngFor="let article of historyArticles" class="history-item">
              <div class="history-header">
                <h4>{{ article.titre }}</h4>
                <span class="status-badge"
                      [class]="'status-' + article.statut.toLowerCase().replace('_', '-')">
                  {{ getStatusLabel(article.statut) }}
                </span>
              </div>
              <div class="history-details">
                <p><strong>Prix:</strong> {{ article.prix }} FCFA</p>
                <p><strong>Vendeur:</strong> {{ article.vendeur.nom || 'N/A' }} ({{ article.vendeur.telephone }})</p>
                <p><strong>Publié le:</strong> {{ article.publieLe | date:'dd/MM/yyyy HH:mm' }}</p>
                <p><strong>Statut:</strong> {{ getStatusLabel(article.statut) }}</p>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="pagination" *ngIf="historyTotalPages > 1">
            <button class="btn-page" (click)="changeHistoryPage(historyCurrentPage - 1)" [disabled]="historyCurrentPage === 1">Précédent</button>
            <span *ngFor="let page of [].constructor(historyTotalPages); let i = index">
              <button class="btn-page" [class.active]="i + 1 === historyCurrentPage" (click)="changeHistoryPage(i + 1)">{{ i + 1 }}</button>
            </span>
            <button class="btn-page" (click)="changeHistoryPage(historyCurrentPage + 1)" [disabled]="historyCurrentPage === historyTotalPages">Suivant</button>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div *ngIf="isActiveSection('settings')" class="admin-sections">
        <div class="section-card">
          <h3>Paramètres Système</h3>
          <p>Fonctionnalité à implémenter : Configuration générale, paramètres de sécurité, maintenance.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Notifications Panel -->
  <div *ngIf="showNotifications" class="notifications-panel">
    <div class="notifications-header">
      <h3>Notifications</h3>
      <button class="btn-close" (click)="toggleNotifications()">&times;</button>
    </div>
    <div class="notifications-content">
      <div *ngIf="notifications.length === 0" class="no-notifications">
        <p>Aucune notification</p>
      </div>
      <div *ngFor="let notification of notifications" class="notification-item" [class.unread]="!notification.lue">
        <div class="notification-icon">
          {{ getNotificationIcon(notification.type) }}
        </div>
        <div class="notification-content">
          <h4>{{ notification.titre }}</h4>
          <p>{{ notification.message }}</p>
          <small>{{ notification.creeLe | date:'dd/MM/yyyy HH:mm' }}</small>
        </div>
        <div class="notification-actions">
          <button class="btn-delete-notification" (click)="deleteNotification(notification.id)">🗑️</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div *ngIf="showRejectModal" class="modal" (click)="closeRejectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Rejeter l'article</h3>
        <button class="modal-close" (click)="closeRejectModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Veuillez indiquer la raison du rejet de cet article. Cette raison sera communiquée au vendeur.</p>
        <textarea
          class="reject-textarea"
          [(ngModel)]="rejectReason"
          placeholder="Raison du rejet..."
          rows="4"
          maxlength="500"
        ></textarea>
        <p class="char-count">{{ rejectReason.length }}/500 caractères</p>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeRejectModal()">Annuler</button>
        <button class="btn-confirm-reject" (click)="confirmReject()" [disabled]="!rejectReason.trim()">Confirmer le rejet</button>
      </div>
    </div>
  </div>
</div>